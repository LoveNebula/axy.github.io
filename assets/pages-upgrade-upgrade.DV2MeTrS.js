import{J as e,N as t,O as s,s as a,P as l,Q as o,f as i,w as n,i as d,j as c,k as r,l as u,t as h,F as f,G as p,H as g,m as w,R as F,q as _,S as k,T as P,u as m,p as v}from"./index-CPBjD6nT.js";import{_ as x}from"./_plugin-vue_export-helper.BCo6x5W8.js";let y=null;const b=x({data:()=>({versionData:{},logList:[],installForBeforeFilePath:"",installed:!1,installing:!1,downloadSuccess:!1,downloading:!1,downLoadPercent:0,downloadedSize:0,packageFileSize:0,tempFilePath:"",title:"更新日志",contents:"",subTitle:"发现新版本",downLoadBtnTextiOS:"立即跳转更新",downLoadBtnText:"立即下载更新",downLoadingText:"安装包下载中，请稍后"}),onLoad(e){this.versionData=JSON.parse(e.data),this.logList=this.versionData.log.split("、")},onBackPress(){y&&y.abort()},methods:{async closeUpdate(){if(!this.downloading)return this.downloadSuccess&&this.tempFilePath?(await this.saveFile(this.tempFilePath,this.version),void t()):void t();e({title:"是否取消下载？",cancelText:"否",confirmText:"是",success:e=>{e.confirm&&(y&&y.abort(),t())}})},downloadPackage(){this.downloading=!0,this.versionData.wgtUrl,this.versionData.type,y=s({url:`${a.getters.allEnv[a.getters.envKey].baseUrl}/dev/file/download?id=${this.versionData.wgtUrl}`,success:e=>{200==e.statusCode&&(this.downloadSuccess=!0,this.tempFilePath=e.tempFilePath)},complete:()=>{this.downloading=!1,this.downLoadPercent=0,this.downloadedSize=0,this.packageFileSize=0,y=null}}),y.onProgressUpdate((e=>{this.downLoadPercent=e.progress,this.downloadedSize=(e.totalBytesWritten/Math.pow(1024,2)).toFixed(2),this.packageFileSize=(e.totalBytesExpectedToWrite/Math.pow(1024,2)).toFixed(2)}))},installPackage(){this.installing=!0,plus.runtime.install(this.tempFilePath,{force:!1},(async e=>{this.installing=!1,this.installed=!0}),(async t=>{this.installForBeforeFilePath&&(await this.deleteSavedFile(this.installForBeforeFilePath),this.installForBeforeFilePath=""),this.installing=!1,this.installed=!1,e({title:"更新失败，请重新下载",content:t.message,showCancel:!1})}))},restart(){this.installed=!1},saveFile:(e,t)=>new Promise(((t,s)=>{l({tempFilePath:e,success({savedFilePath:e}){},complete(){t()}})})),deleteSavedFile:e=>o({filePath:e})}},[["render",function(e,t,s,a,l,o){const x=_,y=d,b=k,S=P,L=m,T=v;return c(),i(y,{class:"mask flex-center"},{default:n((()=>[r(y,{class:"content botton-radius"},{default:n((()=>[r(y,{class:"content-top"},{default:n((()=>[r(x,{class:"content-top-text"},{default:n((()=>[u(h(l.title),1)])),_:1})])),_:1}),r(y,{class:"content-header"}),r(y,{class:"content-body"},{default:n((()=>[r(y,{class:"title"},{default:n((()=>[r(x,null,{default:n((()=>[u(h(l.subTitle)+"v"+h(l.versionData.version),1)])),_:1})])),_:1}),r(y,{class:"body"},{default:n((()=>[r(b,{class:"box-des-scroll","scroll-y":"true"},{default:n((()=>[(c(!0),f(g,null,p(l.logList,((e,t)=>(c(),i(y,{key:t},{default:n((()=>[r(x,{class:"box-des"},{default:n((()=>[u(h(e),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1}),r(y,{class:"footer flex-center"},{default:n((()=>[l.downloadSuccess?l.downloadSuccess&&!l.installed?(c(),i(L,{key:1,class:"content-button",style:{border:"none",color:"#fff"},plain:"",loading:l.installing,disabled:l.installing,onClick:o.installPackage},{default:n((()=>[u(h(l.installing?"正在安装……":"下载完成，立即安装"),1)])),_:1},8,["loading","disabled","onClick"])):w("",!0):(c(),f(g,{key:0},[l.downloading?(c(),i(y,{key:0,class:"progress-box flex-column"},{default:n((()=>[r(S,{class:"progress","border-radius":"35",percent:l.downLoadPercent,activeColor:"#3DA7FF","show-info":"","stroke-width":"10"},null,8,["percent"]),r(y,{style:{width:"100%","font-size":"28rpx",display:"flex","justify-content":"space-around"}},{default:n((()=>[r(x,null,{default:n((()=>[u(h(l.downLoadingText),1)])),_:1}),r(x,null,{default:n((()=>[u("("+h(l.downloadedSize)+"/"+h(l.packageFileSize)+"M)",1)])),_:1})])),_:1})])),_:1})):(c(),i(L,{key:1,class:"content-button",style:{border:"none",color:"#fff"},plain:"",onClick:o.downloadPackage},{default:n((()=>[u(h(l.downLoadBtnText),1)])),_:1},8,["onClick"]))],64)),l.installed?(c(),i(L,{key:2,class:"content-button",style:{border:"none",color:"#fff"},plain:"",onClick:o.restart},{default:n((()=>[u(" 安装完毕，点击重启 ")])),_:1},8,["onClick"])):w("",!0)])),_:1})])),_:1}),r(T,{class:"close-img",src:"/assets/app_update_close-DKiT_s6F.png",onClick:F(o.closeUpdate,["stop"])},null,8,["onClick"])])),_:1})])),_:1})}],["__scopeId","data-v-a5b8f443"]]);export{b as default};
